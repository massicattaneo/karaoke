<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title></title>
    <script src="js/sounds.js"></script>
    <script src="js/soundLoader.js"></script>
    <script src="js/newPitchShift.js"></script>
    <script src="../temp/JSMIDIparser.js"></script>

    <!-- bower:scss -->
    <!-- endbower -->

    <!-- bower:js -->
    <script src="../bower_components/jquery/dist/jquery.js"></script>
    <script src="../bower_components/jQuery/dist/jquery.js"></script>
    <script src="../bower_components/core/build/core.min.js"></script>
    <script src="../bower_components/bootstrap-sass/assets/javascripts/bootstrap.js"></script>
    <!-- endbower -->

    <!-- JAVASCRIPT INIT  -->
    <script>

        sounds.loader(["piano"]);

        var pianoBuffer;

        var library = {};

        sounds.soundsReady = function () {
            for (b in buffers) {
                Instruments[bufferNames[b]] = {}
                Instruments[bufferNames[b]].buffers = buffers[b];
            }

            playSequence();
        }

        function playSequence() {

            // We'll start playing the rhythm 100 milliseconds from "now"
            var startTime = sounds.audioContext.currentTime + 0.100;
            var tempo = 60; // BPM (beats per minute)
            var eighthNoteTime = (60 / tempo) / 2;

            playSound("piano", "C4", 0);

            playSound("piano", "D4", 2);


            //Piano
            for (var bar = 0; bar < 1; bar++) {
                var time = startTime + bar * 8 * eighthNoteTime;
                //playSound("piano", "D0", time);
                //playSound("piano", "C4", time, 1 * eighthNoteTime,1);
                //playSound("piano", "D4", time + 1 * eighthNoteTime, 1 * eighthNoteTime, 0.2);
                //playSound("piano", "E4", time + 2 * eighthNoteTime, 1 * eighthNoteTime, 0.1);
                //playSound("piano", "C5", time + 3 * eighthNoteTime, 1 * eighthNoteTime, 0.01);

                ////playSound("piano", "C1", time + 2 * eighthNoteTime);
                ////playSound("piano", "C1", time + 4 * eighthNoteTime);

                //// Play the bass (kick) drum on beats 1, 5
                //playSound("drum", "C0", time);
                //playSound("drum", "C0", time + 3.5 * eighthNoteTime);
                //playSound("drum", "C0", time + 4 * eighthNoteTime);

                ////// Play the snare drum on beats 3, 7
                //playSound("drum", "C1", time + 2 * eighthNoteTime);
                //playSound("drum", "C1", time + 6 * eighthNoteTime);

                //////// Play the hi-hat every eighth note.
                //playSound("drum", "C2", time + 0 * eighthNoteTime);
                //playSound("drum", "C2", time + 2 * eighthNoteTime);
                //playSound("drum", "C2", time + 3.5 * eighthNoteTime);
                //playSound("drum", "C2", time + 5 * eighthNoteTime);
                //playSound("drum", "C2", time + 6 * eighthNoteTime);
                //playSound("drum", "C2", time + 7 * eighthNoteTime);
            }
        }
        ;

        function playSound(instrument, note, startTime, length, velocity) {
            var source = sounds.audioContext.createBufferSource();
            var abs;
            if (isNaN(note))
                abs = new sounds.note(note).absVal;
            else
                abs = note;

            source.buffer = Instruments[bufferNames[b]].buffers.bufferList[abs];
            source.connect(sounds.audioContext.destination);
            //startTime in seconds
            source.start(startTime);
            if (length) source.stop(startTime + length);
        }

    </script>
</head>
<body>
Simple example for JSMIDIParser
<br/>
<input type="file" id="filereader"/>
<script src="JSMIDIParser.js"></script>
<script>

    // JSMIDIParser
    JSMIDIParser.IO('filereader', playFile);

    var startTime = sounds.audioContext.currentTime + 0.100;
    var tempo = 60; // BPM (beats per minute)
    var eighthNoteTime = (60 / tempo) / 2;

    //Piano
    for (var bar = 0; bar < 1; bar++) {
        var time = startTime + bar * 8 * eighthNoteTime;


        // Your callback function
        function playFile(obj) {

            var startTime = sounds.audioContext.currentTime + 0.100;
            var tempo = 120;
            var quarterNoteInSec = (60 / tempo);
            var timing = startTime;
            var channel = 3;
            console.log(obj.timeDivision);


            for (e in obj.track[channel].event) {
                var t = obj.track[channel].event[e];

                if (t.type == 9) {
                    timing += (t.deltaTime / obj.timeDivision) * quarterNoteInSec;
                    console.log(t);
                    //console.log(t.data[0], t.data[1]);
                    //playSound("piano", t.data[0], timing);
                }
            }
        }
    }
</script>
</body>
</html>
